<!DOCTYPE html>

<html>
<head>
<title>Bif File Parser</title>

<meta http-equiv="content-type" content="text/html; charset=UTF-8">

<style type="text/css">
    body { 
        font: 14px Arial; 
    }
</style>

<script type="text/javascript">

    var BifParser = {
	
        headerByteSize: 64,

        validateBifMagicString: function(magicIdentifier) {
            // 9 byte value
            if ( magicIdentifier != 1179206281 ) {
                return false;
            }

            return true;
        },
		
        getHeaderValue: function(b, title) {
            var rawBytes = Array();
			
            for ( var i = 0; i < b.length; i++ ) {
                rawBytes.push(b[i].charCodeAt(0) & 0xff);
            }
			
            var value = ByteUtilites.shift32Bits(rawBytes,0);

            // console.log("---- var " + title + " = ", value);
            document.getElementById(title).innerHTML = title + " = " + value;

            return value;
        },

        getHeaderInfo: function(b) {
            if( !b || b.length < this.headerByteSize ) {
                return false;
            }
			
            var magicString = this.getHeaderValue(b.slice(0,9), "magicIdentifier");

            if ( !this.validateBifMagicString(magicString) ) {
                return false;
            }

            var version = this.getHeaderValue(b.slice(8,12), "version");
			
            if ( version != 0 ) {
                return false;
            }
			
            var imageCount = this.getImageCount(b);
			
			if ( imageCount == 0 ) {
				return false;
			}
			
            var timestampMultipler = this.getHeaderValue(b.slice(16,20), "timestampMultipler");

            return true;
        },
		
        getImageCount: function(b) {
            return this.getHeaderValue(b.slice(12,16), "imageCount");
        },
		
        getFrameInfo: function(b, index) {

            var bifIndexSearchAtPosition = this.headerByteSize + (8 * index);
			
            // console.log("---- var bifIndexSearchAtPosition = ", bifIndexSearchAtPosition);
			
            var indexBytes = [b[bifIndexSearchAtPosition].charCodeAt(0) & 0xff,b[bifIndexSearchAtPosition+1].charCodeAt(0) & 0xff,
                              b[bifIndexSearchAtPosition+2].charCodeAt(0) & 0xff,b[bifIndexSearchAtPosition+3].charCodeAt(0) & 0xff];
            var frameIndex = ByteUtilites.shift32Bits(indexBytes,0);
            // console.log("---- var frameIndex = ", frameIndex);

            bifIndexSearchAtPosition += 4;

            var frameOffsetBytes = [b[bifIndexSearchAtPosition].charCodeAt(0) & 0xff,b[bifIndexSearchAtPosition+1].charCodeAt(0) & 0xff,
                                    b[bifIndexSearchAtPosition+2].charCodeAt(0) & 0xff,b[bifIndexSearchAtPosition+3].charCodeAt(0) & 0xff];
            frameOffset = ByteUtilites.shift32Bits(frameOffsetBytes,0);
            
            // console.log("---- var frameOffset = ", frameOffset);
			
            return [frameIndex, frameOffset];
		},
		
        encodeImage: function(buffer) {
            var forwardPNGEncodeString = "data:image/png;base64,";
            var forwardJPEGEncodeString = "data:image/jpeg;base64,";
			
            // console.log("---- var buffer[] = ", buffer);

            var base64Buffer = ByteUtilites.Base64.encode(buffer);
            // console.log("---- var base64Buffer = ", base64Buffer);

            // dump to the window
            finalBase64Encode = forwardJPEGEncodeString + base64Buffer;

            if ( buffer.slice(1,4) == "PNG" ) {
                finalBase64Encode = forwardPNGEncodeString + base64Buffer;
            }

            // console.log("finalBase64Encode = ", finalBase64Encode);  
			return finalBase64Encode;
        },
		
        getFrame: function(b, index) {
            var j = 0;
            var buffer = "";
			
            frameByteIndex = this.getFrameInfo(b, index)[1];
            nextFrameByteIndex = this.getFrameInfo(b, index+1)[1];

            for (var i = frameByteIndex; i <= nextFrameByteIndex-1; i++ ) {
                buffer += b[i];
                j++;
            }
			
			var finalBase64Encode = this.encodeImage(buffer);
            document.getElementById("foundimage").setAttribute("src",finalBase64Encode);
        },		

        getSequenceOfFrames: function(b, startAtIndex, maxImageCount) {
            var processImageCount = 0;
            var frameOffset = 0;
            var previousFrameOffset = 0;
            var offsetMessageInfo = "";

            while( processImageCount <= maxImageCount ) {
			
                var frameInfo = this.getFrameInfo(b, startAtIndex);
                var frameIndex = frameInfo[0];
                var frameOffset = frameInfo[1];

                offsetMessageInfo += "<br />" + " index: " + frameIndex + " fos bytes: " + frameOffset;

                if ( processImageCount > 0 ) {

                    var j = 0;
                    var buffer = "";

                    for (var i = previousFrameOffset; i <= frameOffset-1; i++ ) {
                        buffer += b[i];
                        j++;
                    }

                    // dump to the window
                    var finalBase64Encode = this.encodeImage(buffer);
                    document.getElementById("image" + processImageCount).setAttribute("src", finalBase64Encode);
                }

                previousFrameOffset = frameOffset;
                // console.log("---- var previousFrameOffset = ", previousFrameOffset);

				startAtIndex += 1;
                processImageCount += 1;
            }

            document.getElementById("offsetMessageInfo").innerHTML = "[offsetMessageInfo]" + offsetMessageInfo;
        }
    }

    var ByteUtilites = {
        shift32Bits: function(arr, offs) {
		
            // console.log("--- shift32Bits in: ", arr);

            // little endianness, shift 4 bytes in reverse
            var out = (arr[offs+3] << 24) + (arr[offs+2] << 16) + (arr[offs+1] << 8) + arr[offs+0];

            // console.log("--- shift32Bits out: ", out);

            return out;
        },

        Base64 : {

            _keyStr : "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",

            encode : function (input) {
                var output = "";
                var chr1, chr2, chr3, enc1, enc2, enc3, enc4;
                var i = 0;

                while (i < input.length) {

                    chr1 = input.charCodeAt(i++) & 0xff;
                    chr2 = input.charCodeAt(i++) & 0xff;
                    chr3 = input.charCodeAt(i++) & 0xff;

                    enc1 = chr1 >> 2;
                    enc2 = ((chr1 & 3) << 4) | (chr2 >> 4);
                    enc3 = ((chr2 & 15) << 2) | (chr3 >> 6);
                    enc4 = chr3 & 63;

                    if (isNaN(chr2)) {
                        enc3 = enc4 = 64;
                    } else if (isNaN(chr3)) {
                        enc4 = 64;
                    }

                    output = output +
                    this._keyStr.charAt(enc1) + this._keyStr.charAt(enc2) +
                    this._keyStr.charAt(enc3) + this._keyStr.charAt(enc4);
                }

                return output;
            }
			
        }
		
    }

    var WebBrowserInterface = {
        imageFrameCount: 4,
        bifImageCount: 0,
        bifFrameIndex: 0,
        bifBinary: null,

        reset: function() {
            this.bifImageCount = 0;
            this.bifFrameIndex = 0;
            this.bifBinary = null;
        },

        uploadBifBlob: function(files) {
            // reset the indices
            this.reset();
			
            if (!files) {
                alert('Files not found!');
                return;
            }

            if (!files.length) {
                alert('Please select a bif file!');
                return;
            }

            var file = files[0];
			
            var reader = new FileReader();

            reader.onloadend = function(evt) {
                if (evt.target.readyState == FileReader.DONE) {
                    document.getElementById('bytes').textContent = ' bytes = ' + file.size;
					
                    var result = evt.target.result;
                    WebBrowserInterface.bifBinary = result;
					
                    // console.log("WebBrowserInterface.bifBinary = " + WebBrowserInterface.bifBinary);
					
                    if ( !BifParser.getHeaderInfo(result) ) {
                        alert('Invalid bif file.');
                        return;
                    }
					
                    WebBrowserInterface.bifImageCount = BifParser.getImageCount(result);
					
                    BifParser.getSequenceOfFrames(result, 0, WebBrowserInterface.imageFrameCount);
                }
            };

            reader.onerror = function(evt) {
                // console.log("error reading: code " + evt.target.error.code);

                switch(evt.target.error.code) {
                case evt.target.error.NOT_FOUND_ERR:
                    alert('evt.target.error.NOT_FOUND_ERR');
                    break;
                case evt.target.error.NOT_READABLE_ERR:
                    alert('evt.target.error.NOT_READABLE_ERRR');
                    break;
                case evt.target.error.ENCODING_ERR:
                    alert('evt.target.error.ENCODING_ERR');
                    break;
                case evt.target.error.SECURITY_ERR:
                    alert('evt.target.error.SECURITY_ERR');
                    break;
                case evt.target.error.ABORT_ERR:
                    break;
                default:
                    alert('An error occurred reading this file.');
                }
            }
	
            reader.readAsBinaryString(file);
        },

        pushFrame: function(index) {
            // console.log("this.bifFrameIndex = " + this.bifFrameIndex + " this.bifImageCount = " + this.bifImageCount);
            // console.log("this.bifBinary (memory) = " + this.bifBinary.length);

            // backward protection
            if ( this.bifFrameIndex + index < 0 ) {
                return;
            }

            // forward protection
            if ( index != -1 && (this.bifFrameIndex >= (this.bifImageCount - this.imageFrameCount)) ) {
                return;
            }

            this.bifFrameIndex += index;
            BifParser.getSequenceOfFrames(this.bifBinary, this.bifFrameIndex, this.imageFrameCount);
        },
		
        findFrame: function(index) {
            if ( index < 1 ) {
                alert("Minimum frame index is 1");
                return;
            }
			
            if ( index > this.bifImageCount ) {
                alert("Maximum frame index is " + this.bifImageCount);
                return;
            }
			
            BifParser.getFrame(this.bifBinary, parseInt(index-1));
        },
		
        initInterface: function() {
            document.querySelector('.readBytesButtons').addEventListener('click', function(evt) {
                if (evt.target.tagName.toLowerCase() == 'button') {
                    var files = document.getElementById('files').files;
                    WebBrowserInterface.uploadBifBlob(files);
                }
            }, false);
		
            document.querySelector('.updateIndexButtons').addEventListener('click', function(evt) {
                if (evt.target.tagName.toLowerCase() == 'button') {
                   var index = document.getElementById('imageindex').value;
                   WebBrowserInterface.findFrame(index);
                }
            }, false);
        }
    }

</script>
</head>
    <body onload="javascript:WebBrowserInterface.initInterface();">

    <fieldset>

        <legend>Upload Bif file</legend>

        <input type="file" id="files" name="file" size="70" />
        <span class="readBytesButtons">
            <button id="testing">Read and Parse</button>
        </span>
		
        <hr/>
		
        <table>
            <tr>
                <td valign="top" style="padding:5px">
                    <div id="bytes">bytes = </div>
                    <div id="magicIdentifier">magicIdentifier = </div>
                    <div id="version">version = </div>
                    <div id="imageCount">imageCount = </div>
                    <div id="timestampMultipler">timestampMultipler = </div>
                </td>
                <td valign="top" style="padding:5px">
                    <div id="offsetMessageInfo">[offsetMessageInfo]</div>
                </td>
            </tr>
        </table>

        <button onclick="javascript:WebBrowserInterface.pushFrame(-1);"><<</button> 
        <img id="image1" /> 
        <img id="image2" /> 
        <img id="image3" /> 
        <img id="image4" /> 
        <button onclick="javascript:WebBrowserInterface.pushFrame(1);">>></button>
		
        <hr/>
		
        <input type="text" id="imageindex" size="3" />
		
        <span class="updateIndexButtons">
            <button id="updateIndex">Find Image at Index</button>
        </span>
        <br /><br />
        <img id="foundimage" /> 

    </fieldset>

    </body>
</html>
